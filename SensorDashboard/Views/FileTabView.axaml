<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:SensorDashboard.ViewModels"
             xmlns:ui="using:FluentAvalonia.UI.Controls"
             xmlns:local="using:SensorDashboard"
             xmlns:views="using:SensorDashboard.Views"
             mc:Ignorable="d" d:DesignWidth="500" d:DesignHeight="450"
             x:Class="SensorDashboard.Views.FileTabView"
             x:DataType="vm:FileTabViewModel"
             x:Name="ThisFileTabView">

    <UserControl.Resources>
        <local:DataGridCellColorMultiConverter x:Key="DataGridCellColorMultiConverter" />
    </UserControl.Resources>

    <UserControl.Styles>

        <Style Selector="Grid > NumericUpDown, Grid > ui|NumberBox, Grid > Label">
            <!-- Apply same margin value to all direct-child text boxes. -->
            <Setter Property="Margin" Value="8 4" />
        </Style>

        <Style Selector="Grid > NumericUpDown, Grid > ui|NumberBox, DataGridCell">
            <!-- Use tabular figures for numerical inputs so text width
                 doesn't change as value changes. -->
            <Setter Property="FontFeatures" Value="tnum" />
        </Style>

        <Style Selector="Grid > :is(Control)">
            <!-- Vertically centre all Grid child controls. -->
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>

        <!-- Colour DataGridCells based on their numerical value. -->
        <Style Selector="TreeDataGridTextCell">
            <Setter Property="Background">
                <!-- Use a multi-binding so changes to either the grid cell
                     content, min or max values will trigger style update. -->
                <MultiBinding Converter="{StaticResource DataGridCellColorMultiConverter}">
                    <Binding Path="((vm:FileTabViewModel)DataContext).ThresholdMinimum"
                             RelativeSource="{RelativeSource AncestorType=views:FileTabView}"
                             FallbackValue="0" />
                    <Binding Path="((vm:FileTabViewModel)DataContext).ThresholdMaximum"
                             RelativeSource="{RelativeSource AncestorType=views:FileTabView}"
                             FallbackValue="100" />
                    <!-- Use a reflection binding to prevent errors. -->
                    <ReflectionBinding Path="$self.((Border)VisualChildren[0]).((TextBlock)Child).Text"
                                       FallbackValue="" />
                    <!-- Pass self into multi-converter so dynamic resource
                         background can be applied. -->
                    <Binding Path="$self" />
                </MultiBinding>
            </Setter>
            <Setter Property="Foreground" Value="{DynamicResource DataGridCellForegroundBrush}" />
            <Style Selector="^ TextBlock">
                <Setter Property="TextAlignment" Value="Center" />
            </Style>
        </Style>

    </UserControl.Styles>

    <Grid RowDefinitions="Auto, *"
          Margin="8">

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*" MinWidth="150" MaxWidth="250" />
            <ColumnDefinition Width="3*" />
        </Grid.ColumnDefinitions>

        <ui:CommandBar Grid.Column="0"
                       Grid.Row="0"
                       Grid.ColumnSpan="2"
                       DefaultLabelPosition="Right"
                       Margin="0 0 0 8">

            <ui:CommandBar.PrimaryCommands>

                <ui:CommandBarButton
                    Label="Open"
                    IconSource="Folder"
                    Click="OpenFileButton_OnClick" />

                <ui:CommandBarButton
                    Label="Save"
                    IconSource="Save"
                    Click="SaveFileButton_OnClick" />

                <ui:CommandBarButton
                    Label="Rename Dataset"
                    IconSource="Edit"
                    Click="RenameDatasetButton_OnClick" />

            </ui:CommandBar.PrimaryCommands>

            <ui:CommandBar.SecondaryCommands>

                <ui:CommandBarButton
                    Label="Open Sample Data"
                    IconSource="List"
                    Click="OpenSampleDataButton_OnClick" />

                <ui:CommandBarButton
                    Label="Show Hot Keys"
                    IconSource="Keyboard"
                    Click="ShowHotKeysButton_OnClick" />

            </ui:CommandBar.SecondaryCommands>

        </ui:CommandBar>

        <StackPanel Grid.Column="0"
                    Grid.Row="1"
                    VerticalAlignment="Top"
                    Margin="0 8 0 0">

            <Label Content="Total average:" />
            <NumericUpDown IsReadOnly="True"
                           FormatString="0.00"
                           ShowButtonSpinner="False"
                           Focusable="False"
                           Value="{Binding AverageTotal}" />

            <Label Content="Row average:" />
            <NumericUpDown IsReadOnly="True"
                           FormatString="0.00"
                           ShowButtonSpinner="False"
                           Focusable="False"
                           Value="{Binding AverageRow, TargetNullValue=0}" />

            <Label Content="Threshold min:" />
            <ui:NumberBox AcceptsExpression="True"
                          HorizontalAlignment="Stretch"
                          SpinButtonPlacementMode="Inline"
                          SimpleNumberFormat="0.00"
                          Value="{Binding ThresholdMinimum}"
                          Maximum="{Binding ThresholdMaximum}" />

            <Label Content="Threshold max:" />
            <ui:NumberBox AcceptsExpression="True"
                          HorizontalAlignment="Stretch"
                          SpinButtonPlacementMode="Inline"
                          SimpleNumberFormat="0.00"
                          Value="{Binding ThresholdMaximum}"
                          Minimum="{Binding ThresholdMinimum} " />
        </StackPanel>

        <Border Grid.Row="1"
                Grid.Column="1"
                CornerRadius="8"
                VerticalAlignment="Stretch"
                HorizontalAlignment="Stretch"
                Margin="8 0 -3 -3"
                BoxShadow="{DynamicResource DataGridShadow}">

            <Border CornerRadius="{Binding $parent.CornerRadius}"
                    ClipToBounds="True"
                    VerticalAlignment="Stretch"
                    HorizontalAlignment="Stretch">

                <TreeDataGrid x:Name="DataGridDisplay"
                              Source="{Binding DataGridSource}"
                              CanUserResizeColumns="False"
                              CanUserSortColumns="False"
                              VerticalAlignment="Top" />
            </Border>
        </Border>

    </Grid>
</UserControl>
